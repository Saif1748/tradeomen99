rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // üß† HELPER FUNCTIONS
    // =========================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // üõ°Ô∏è ROBUST ACCESS CHECK
    function hasAccessToAccount(data) {
      return isAuthenticated() && (
        (data.keys().hasAny(['ownerId']) && data.ownerId == request.auth.uid) || 
        (data.keys().hasAny(['memberIds']) && data.memberIds.hasAny([request.auth.uid]))
      );
    }

    // üîó Helper to fetch an account's data safely
    function getAccountData(accountId) {
      return get(/databases/$(database)/documents/accounts/$(accountId)).data;
    }

    // Check if user is member of the Account linked to a resource
    function isMemberOfLinkedAccount(resourceData) {
      return hasAccessToAccount(getAccountData(resourceData.accountId));
    }

    // =========================================================
    // üíå INVITATIONS
    // =========================================================
    match /invitations/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        hasAccessToAccount(getAccountData(resource.data.accountId))
      );
      
      allow create: if isAuthenticated() && 
        hasAccessToAccount(getAccountData(request.resource.data.accountId));
      
      allow update: if isAuthenticated() && resource.data.email == request.auth.token.email;
      
      allow delete: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        hasAccessToAccount(getAccountData(resource.data.accountId))
      );
    }

    // =========================================================
    // üë§ USERS
    // =========================================================
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      match /audit_logs/{logId} { 
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; 
      }
    }

    // =========================================================
    // üè¢ ACCOUNTS
    // =========================================================
    match /accounts/{accountId} {
      allow get, list: if hasAccessToAccount(resource.data);

      allow create: if isAuthenticated() 
                    && request.resource.data.ownerId == request.auth.uid;

      allow update: if hasAccessToAccount(resource.data) 
                    && request.resource.data.ownerId == resource.data.ownerId;

      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;

      // Ledger Sub-collection
      match /ledger/{txnId} {
        allow read: if hasAccessToAccount(getAccountData(accountId));
        allow create: if hasAccessToAccount(getAccountData(accountId));
      }

      // ‚úÖ NEW: Journal (Calendar Notes) Sub-collection
      match /journal/{noteId} {
        allow read, write: if hasAccessToAccount(getAccountData(accountId));
      }
    }

    // =========================================================
    // ‚ôüÔ∏è STRATEGIES
    // =========================================================
    match /strategies/{strategyId} {
      allow read: if isMemberOfLinkedAccount(resource.data);
      allow create: if isMemberOfLinkedAccount(request.resource.data);
      allow write: if isMemberOfLinkedAccount(resource.data);
    }

    // =========================================================
    // üìà TRADES & EXECUTIONS
    // =========================================================
    match /trades/{tradeId} {
      allow read: if isMemberOfLinkedAccount(resource.data);
      allow create: if isMemberOfLinkedAccount(request.resource.data);
      allow update: if isMemberOfLinkedAccount(resource.data)
                    && request.resource.data.accountId == resource.data.accountId;
      allow delete: if isMemberOfLinkedAccount(resource.data);

      match /executions/{executionId} {
        allow read: if isMemberOfLinkedAccount(
          get(/databases/$(database)/documents/trades/$(tradeId)).data
        );
        allow create, update: if hasAccessToAccount(getAccountData(request.resource.data.accountId));
        allow delete: if hasAccessToAccount(getAccountData(resource.data.accountId));
      }
    }

    // =========================================================
    // üïµÔ∏è ACTIVITY LOGS
    // =========================================================
    match /activities/{activityId} {
      allow read: if isMemberOfLinkedAccount(resource.data);
      allow create: if isMemberOfLinkedAccount(request.resource.data);
      allow update, delete: if false; 
    }
  }
}